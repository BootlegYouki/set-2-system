{"version":3,"file":"_server-RWBBNFYA.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/admin-settings/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { q as query } from \"../../../../chunks/db.js\";\nimport { v as verifyAuth } from \"../../../../chunks/auth-helper.js\";\nasync function GET({ request }) {\n  try {\n    const authResult = await verifyAuth(request, [\"admin\"]);\n    if (!authResult.success) {\n      return json({ error: authResult.error }, { status: authResult.status });\n    }\n    const result = await query(\n      \"SELECT setting_key, setting_value, setting_type FROM admin_settings ORDER BY setting_key\"\n    );\n    const settings = {};\n    result.rows.forEach((row) => {\n      let value = row.setting_value;\n      if (row.setting_type === \"number\" && value !== null) {\n        value = parseFloat(value);\n      } else if (row.setting_type === \"boolean\" && value !== null) {\n        value = value === \"true\";\n      } else if (row.setting_type === \"date\" && value !== null) {\n        value = value;\n      } else if (row.setting_type === \"json\" && value !== null) {\n        try {\n          value = JSON.parse(value);\n        } catch (e) {\n          console.error(\"Failed to parse JSON setting:\", row.setting_key, e);\n        }\n      }\n      settings[row.setting_key] = value;\n    });\n    return json({\n      success: true,\n      data: settings\n    });\n  } catch (error) {\n    console.error(\"Error fetching admin settings:\", error);\n    return json(\n      { error: \"Failed to fetch admin settings\" },\n      { status: 500 }\n    );\n  }\n}\nasync function PUT({ request, getClientAddress }) {\n  try {\n    const authResult = await verifyAuth(request, [\"admin\"]);\n    if (!authResult.success) {\n      return json({ error: authResult.error }, { status: authResult.status });\n    }\n    const body = await request.json();\n    const { settings } = body;\n    if (!settings || typeof settings !== \"object\") {\n      return json(\n        { error: \"Invalid settings data provided\" },\n        { status: 400 }\n      );\n    }\n    await query(\"BEGIN\");\n    try {\n      for (const [key, value] of Object.entries(settings)) {\n        let stringValue = value;\n        if (typeof value === \"object\" && value !== null) {\n          stringValue = JSON.stringify(value);\n        } else if (value !== null) {\n          stringValue = String(value);\n        }\n        if (key.includes(\"date\") && value !== null && value !== \"\") {\n          const dateRegex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])-\\d{4}$/;\n          if (!dateRegex.test(value)) {\n            throw new Error(`Invalid date format for ${key}. Expected MM-DD-YYYY format.`);\n          }\n          const [month, day, year] = value.split(\"-\");\n          const date = new Date(year, month - 1, day);\n          if (isNaN(date.getTime()) || date.getFullYear() != year || date.getMonth() != month - 1 || date.getDate() != day) {\n            throw new Error(`Invalid date value for ${key}: ${value}`);\n          }\n        }\n        await query(\n          `UPDATE admin_settings \n\t\t\t\t\t SET setting_value = $1, updated_at = CURRENT_TIMESTAMP \n\t\t\t\t\t WHERE setting_key = $2`,\n          [stringValue, key]\n        );\n      }\n      const ip_address = getClientAddress();\n      await query(\n        `SELECT log_activity($1, $2, $3, $4, $5, $6)`,\n        [\n          \"admin_settings_updated\",\n          authResult.user.id,\n          authResult.user.account_number,\n          JSON.stringify({ updated_settings: Object.keys(settings) }),\n          ip_address,\n          request.headers.get(\"user-agent\")\n        ]\n      );\n      await query(\"COMMIT\");\n      return json({\n        success: true,\n        message: \"Admin settings updated successfully\"\n      });\n    } catch (error) {\n      await query(\"ROLLBACK\");\n      throw error;\n    }\n  } catch (error) {\n    console.error(\"Error updating admin settings:\", error);\n    return json(\n      { error: \"Failed to update admin settings\" },\n      { status: 500 }\n    );\n  }\n}\nexport {\n  GET,\n  PUT\n};\n"],"names":[],"mappings":"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"}