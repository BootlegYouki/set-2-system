{"version":3,"file":"_server-vFxnc-ts.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/auth/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { a as connectToDatabase } from \"../../../../chunks/db.js\";\nimport bcrypt from \"bcrypt\";\nlet globalLoginAttempts = { attempts: 0, lockedUntil: null };\nconst MAX_LOGIN_ATTEMPTS = 3;\nconst LOCKOUT_DURATION_MS = 10 * 60 * 1e3;\nfunction checkLoginAttempts() {\n  if (globalLoginAttempts.lockedUntil && /* @__PURE__ */ new Date() >= globalLoginAttempts.lockedUntil) {\n    globalLoginAttempts = { attempts: 0, lockedUntil: null };\n    return { isLocked: false, remainingTime: 0, attemptsLeft: MAX_LOGIN_ATTEMPTS };\n  }\n  if (globalLoginAttempts.lockedUntil) {\n    const remainingTime = Math.ceil((globalLoginAttempts.lockedUntil - /* @__PURE__ */ new Date()) / 1e3);\n    return { isLocked: true, remainingTime, attemptsLeft: 0 };\n  }\n  const attemptsLeft = MAX_LOGIN_ATTEMPTS - globalLoginAttempts.attempts;\n  return { isLocked: false, remainingTime: 0, attemptsLeft };\n}\nfunction recordFailedAttempt() {\n  globalLoginAttempts.attempts += 1;\n  if (globalLoginAttempts.attempts >= MAX_LOGIN_ATTEMPTS) {\n    globalLoginAttempts.lockedUntil = new Date(Date.now() + LOCKOUT_DURATION_MS);\n  }\n  return MAX_LOGIN_ATTEMPTS - globalLoginAttempts.attempts;\n}\nfunction clearLoginAttempts() {\n  globalLoginAttempts = { attempts: 0, lockedUntil: null };\n}\nasync function POST({ request, getClientAddress }) {\n  try {\n    const { accountNumber, password } = await request.json();\n    if (!accountNumber || !password) {\n      return json({ error: \"Account number and password are required\" }, { status: 400 });\n    }\n    if (typeof accountNumber !== \"string\" || typeof password !== \"string\") {\n      return json({ error: \"Invalid input format\" }, { status: 400 });\n    }\n    const sanitizedAccountNumber = accountNumber.replace(/[^a-zA-Z0-9\\-_]/g, \"\");\n    if (sanitizedAccountNumber !== accountNumber || accountNumber.length > 50) {\n      return json({ error: \"Invalid account number format\" }, { status: 400 });\n    }\n    if (password.length > 200) {\n      return json({ error: \"Password too long\" }, { status: 400 });\n    }\n    const attemptStatus = checkLoginAttempts();\n    if (attemptStatus.isLocked) {\n      const minutes = Math.floor(attemptStatus.remainingTime / 60);\n      const seconds = attemptStatus.remainingTime % 60;\n      const timeString = minutes > 0 ? `${minutes} minute${minutes > 1 ? \"s\" : \"\"} and ${seconds} second${seconds > 1 ? \"s\" : \"\"}` : `${seconds} second${seconds > 1 ? \"s\" : \"\"}`;\n      return json({\n        error: `Login temporarily unavailable due to too many failed attempts. Please try again in ${timeString}.`,\n        isLocked: true,\n        remainingTime: attemptStatus.remainingTime\n      }, { status: 429 });\n    }\n    const db = await connectToDatabase();\n    const usersCollection = db.collection(\"users\");\n    const user = await usersCollection.findOne({\n      account_number: sanitizedAccountNumber,\n      status: { $ne: \"archived\" }\n      // Simpler condition: not archived = active/null/undefined\n    });\n    if (!user) {\n      const attemptsLeft = recordFailedAttempt();\n      if (attemptsLeft > 0) {\n        return json({\n          error: \"Invalid account number or password\",\n          attemptsLeft\n        }, { status: 401 });\n      } else {\n        return json({\n          error: \"Invalid account number or password. Login has been locked for 10 minutes due to too many failed attempts.\",\n          isLocked: true,\n          attemptsLeft: 0\n        }, { status: 429 });\n      }\n    }\n    const isPasswordValid = await bcrypt.compare(password, user.password_hash);\n    if (!isPasswordValid) {\n      const attemptsLeft = recordFailedAttempt();\n      if (attemptsLeft > 0) {\n        return json({\n          error: \"Invalid account number or password\",\n          attemptsLeft\n        }, { status: 401 });\n      } else {\n        return json({\n          error: \"Invalid account number or password. Login has been locked for 10 minutes due to too many failed attempts.\",\n          isLocked: true,\n          attemptsLeft: 0\n        }, { status: 429 });\n      }\n    }\n    clearLoginAttempts();\n    const userData = {\n      id: user._id,\n      name: user.full_name,\n      firstName: user.first_name,\n      gender: user.gender,\n      accountNumber: user.account_number,\n      accountType: user.account_type\n    };\n    if (user.account_type === \"admin\") {\n      const ip_address = getClientAddress();\n      const user_agent = request.headers.get(\"user-agent\");\n      const activityLogsCollection = db.collection(\"activity_logs\");\n      activityLogsCollection.insertOne({\n        activity_type: \"user_login\",\n        user_id: user._id,\n        user_account_number: user.account_number,\n        activity_data: {\n          full_name: user.full_name,\n          account_type: user.account_type\n        },\n        ip_address,\n        user_agent,\n        created_at: /* @__PURE__ */ new Date()\n      }).catch((logError) => {\n        console.error(\"Error logging login activity:\", logError);\n      });\n    }\n    return json({\n      success: true,\n      user: userData,\n      message: \"Login successful\"\n    });\n  } catch (error) {\n    console.error(\"Authentication error:\", error);\n    if (error.code === \"ECONNREFUSED\" || error.code === \"ENOTFOUND\") {\n      return json({ error: \"Database connection failed\" }, { status: 503 });\n    }\n    return json({ error: \"Authentication failed. Please try again.\" }, { status: 500 });\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}