{"version":3,"file":"_server-CXbCKD7q.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/change-password/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { q as query } from \"../../../../chunks/db.js\";\nimport { v as verifyAuth } from \"../../../../chunks/auth-helper.js\";\nimport bcrypt from \"bcrypt\";\nasync function POST({ request, getClientAddress }) {\n  try {\n    const authResult = await verifyAuth(request, [\"admin\", \"teacher\", \"student\"]);\n    if (!authResult.success) {\n      return json({ error: authResult.error }, { status: authResult.status });\n    }\n    const body = await request.json();\n    const { currentPassword, newPassword } = body;\n    if (!currentPassword || !newPassword) {\n      return json(\n        { error: \"Current password and new password are required\" },\n        { status: 400 }\n      );\n    }\n    if (newPassword.length < 8) {\n      return json(\n        { error: \"New password must be at least 8 characters long\" },\n        { status: 400 }\n      );\n    }\n    const userResult = await query(\n      \"SELECT password_hash FROM users WHERE id = $1\",\n      [authResult.user.id]\n    );\n    if (userResult.rows.length === 0) {\n      return json({ error: \"User not found\" }, { status: 404 });\n    }\n    const isCurrentPasswordValid = await bcrypt.compare(\n      currentPassword,\n      userResult.rows[0].password_hash\n    );\n    if (!isCurrentPasswordValid) {\n      return json(\n        { error: \"Current password is incorrect\" },\n        { status: 401 }\n      );\n    }\n    const newPasswordHash = await bcrypt.hash(newPassword, 10);\n    await query(\n      \"UPDATE users SET password_hash = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2\",\n      [newPasswordHash, authResult.user.id]\n    );\n    const ip_address = getClientAddress();\n    await query(\n      `SELECT log_activity($1, $2, $3, $4, $5, $6)`,\n      [\n        \"password_changed\",\n        authResult.user.id,\n        authResult.user.account_number,\n        JSON.stringify({ action: \"password_change_successful\" }),\n        ip_address,\n        request.headers.get(\"user-agent\")\n      ]\n    );\n    return json({\n      success: true,\n      message: \"Password changed successfully\"\n    });\n  } catch (error) {\n    console.error(\"Error changing password:\", error);\n    return json(\n      { error: \"Failed to change password\" },\n      { status: 500 }\n    );\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}