{"version":3,"file":"auth-helper-VQdrszph.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth-helper.js"],"sourcesContent":["import { q as query } from \"./db.js\";\nasync function getUserFromRequest(request) {\n  try {\n    const userId = request.headers.get(\"x-user-id\");\n    const userAccountNumber = request.headers.get(\"x-user-account-number\");\n    const userName = request.headers.get(\"x-user-name\");\n    if (userId && userAccountNumber && userName) {\n      return {\n        id: parseInt(userId),\n        account_number: userAccountNumber,\n        full_name: decodeURIComponent(userName)\n      };\n    }\n    return null;\n  } catch (error) {\n    console.error(\"Error extracting user from request:\", error);\n    return null;\n  }\n}\nasync function logActivityWithUser(activityType, user, data, ipAddress, userAgent) {\n  try {\n    await query(\n      \"SELECT log_activity($1, $2, $3, $4, $5, $6)\",\n      [\n        activityType,\n        user?.id || null,\n        user?.account_number || null,\n        JSON.stringify(data),\n        ipAddress,\n        userAgent\n      ]\n    );\n  } catch (error) {\n    console.error(`Error logging ${activityType} activity:`, error);\n  }\n}\nasync function verifyAuth(request, allowedRoles = []) {\n  try {\n    const user = await getUserFromRequest(request);\n    if (!user) {\n      return {\n        success: false,\n        error: \"Authentication required\",\n        status: 401\n      };\n    }\n    if (allowedRoles.length > 0) {\n      const result = await query(\n        \"SELECT account_type FROM users WHERE id = $1 AND status = $2\",\n        [user.id, \"active\"]\n      );\n      if (result.rows.length === 0) {\n        return {\n          success: false,\n          error: \"User not found or inactive\",\n          status: 401\n        };\n      }\n      const userAccountType = result.rows[0].account_type;\n      if (!allowedRoles.includes(userAccountType)) {\n        return {\n          success: false,\n          error: \"Insufficient permissions\",\n          status: 403\n        };\n      }\n      user.account_type = userAccountType;\n    }\n    return {\n      success: true,\n      user\n    };\n  } catch (error) {\n    console.error(\"Error verifying authentication:\", error);\n    return {\n      success: false,\n      error: \"Authentication verification failed\",\n      status: 500\n    };\n  }\n}\nexport {\n  getUserFromRequest as g,\n  logActivityWithUser as l,\n  verifyAuth as v\n};\n"],"names":[],"mappings":"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"}