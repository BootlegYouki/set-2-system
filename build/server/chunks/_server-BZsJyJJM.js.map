{"version":3,"file":"_server-BZsJyJJM.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/archived-students/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { q as query } from \"../../../../chunks/db.js\";\nimport { g as getUserFromRequest, l as logActivityWithUser } from \"../../../../chunks/auth-helper.js\";\nasync function GET({ url }) {\n  try {\n    const limit = url.searchParams.get(\"limit\") || \"50\";\n    const search = url.searchParams.get(\"search\") || \"\";\n    const gradeLevel = url.searchParams.get(\"gradeLevel\") || \"\";\n    const gender = url.searchParams.get(\"gender\") || \"\";\n    let selectQuery = `\n      SELECT \n        u.id,\n        u.account_number,\n        u.full_name,\n        u.first_name,\n        u.last_name,\n        u.middle_initial,\n        u.email,\n        u.grade_level,\n        u.birthdate,\n        u.address,\n        u.age,\n        u.guardian,\n        u.contact_number,\n        u.gender,\n        u.archived_at,\n        u.created_at,\n        u.updated_at\n      FROM users u\n      WHERE u.account_type = 'student' AND u.status = 'archived'\n    `;\n    const queryParams = [];\n    let paramIndex = 1;\n    if (search) {\n      selectQuery += ` AND (\n        u.full_name ILIKE $${paramIndex} OR \n        u.account_number ILIKE $${paramIndex} OR\n        u.first_name ILIKE $${paramIndex} OR\n        u.last_name ILIKE $${paramIndex}\n      )`;\n      queryParams.push(`%${search}%`);\n      paramIndex++;\n    }\n    if (gradeLevel) {\n      selectQuery += ` AND u.grade_level = $${paramIndex}`;\n      queryParams.push(gradeLevel);\n      paramIndex++;\n    }\n    if (gender) {\n      selectQuery += ` AND u.gender = $${paramIndex}`;\n      queryParams.push(gender);\n      paramIndex++;\n    }\n    selectQuery += ` ORDER BY u.archived_at DESC LIMIT $${paramIndex}`;\n    queryParams.push(parseInt(limit));\n    const result = await query(selectQuery, queryParams);\n    const archivedStudents = result.rows.map((student) => ({\n      id: student.id,\n      name: student.full_name,\n      firstName: student.first_name,\n      lastName: student.last_name,\n      middleInitial: student.middle_initial,\n      email: student.email,\n      number: student.account_number,\n      gradeLevel: student.grade_level,\n      birthdate: student.birthdate,\n      address: student.address,\n      age: student.age,\n      guardian: student.guardian,\n      contactNumber: student.contact_number,\n      gender: student.gender,\n      archivedDate: student.archived_at ? new Date(student.archived_at).toLocaleDateString(\"en-US\") : \"\",\n      createdDate: new Date(student.created_at).toLocaleDateString(\"en-US\"),\n      updatedDate: new Date(student.updated_at).toLocaleDateString(\"en-US\"),\n      status: \"archived\"\n    }));\n    return json({ students: archivedStudents });\n  } catch (error) {\n    console.error(\"Error fetching archived students:\", error);\n    if (error.code === \"ECONNREFUSED\" || error.code === \"ENOTFOUND\") {\n      return json({ error: \"Database connection failed\" }, { status: 503 });\n    }\n    if (error.message && error.message.includes(\"invalid input syntax\")) {\n      return json({ error: \"Invalid limit parameter\" }, { status: 400 });\n    }\n    return json({ error: \"Failed to fetch archived students\" }, { status: 500 });\n  }\n}\nasync function PUT({ request, getClientAddress }) {\n  try {\n    const { id } = await request.json();\n    if (!id) {\n      return json({ error: \"Student ID is required\" }, { status: 400 });\n    }\n    const checkQuery = `SELECT id, account_type, status FROM users WHERE id = $1`;\n    const checkResult = await query(checkQuery, [id]);\n    if (checkResult.rows.length === 0) {\n      return json({ error: \"Student not found\" }, { status: 404 });\n    }\n    const student = checkResult.rows[0];\n    if (student.account_type !== \"student\") {\n      return json({ error: \"Only students can be restored from archive\" }, { status: 400 });\n    }\n    if (student.status !== \"archived\") {\n      return json({ error: \"Student is not archived\" }, { status: 400 });\n    }\n    const updateQuery = `\n      UPDATE users \n      SET \n        status = 'active',\n        archived_at = NULL,\n        updated_at = CURRENT_TIMESTAMP\n      WHERE id = $1\n      RETURNING id, full_name, account_number\n    `;\n    const result = await query(updateQuery, [id]);\n    const restoredStudent = result.rows[0];\n    try {\n      const user = await getUserFromRequest(request);\n      const ip_address = getClientAddress();\n      const user_agent = request.headers.get(\"user-agent\");\n      await logActivityWithUser(\n        \"account_restored\",\n        user,\n        {\n          account_type: \"student\",\n          full_name: restoredStudent.full_name\n        },\n        ip_address,\n        user_agent\n      );\n    } catch (logError) {\n      console.error(\"Error logging student restoration activity:\", logError);\n    }\n    return json({\n      success: true,\n      message: `Student ${restoredStudent.full_name} (${restoredStudent.account_number}) has been restored from archive`,\n      student: {\n        id: restoredStudent.id,\n        name: restoredStudent.full_name,\n        number: restoredStudent.account_number\n      }\n    });\n  } catch (error) {\n    console.error(\"Error restoring student:\", error);\n    if (error.code === \"ECONNREFUSED\" || error.code === \"ENOTFOUND\") {\n      return json({ error: \"Database connection failed\" }, { status: 503 });\n    }\n    return json({ error: \"Failed to restore student from archive\" }, { status: 500 });\n  }\n}\nexport {\n  GET,\n  PUT\n};\n"],"names":[],"mappings":"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"}