{"version":3,"file":"_server-CIqSM534.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/auth/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { q as query } from \"../../../../chunks/db.js\";\nimport bcrypt from \"bcrypt\";\nasync function POST({ request, getClientAddress }) {\n  try {\n    const { accountNumber, password } = await request.json();\n    if (!accountNumber || !password) {\n      return json({ error: \"Account number and password are required\" }, { status: 400 });\n    }\n    const userQuery = `\n      SELECT \n        u.id,\n        u.account_number,\n        u.full_name,\n        u.first_name,\n        u.gender,\n        u.account_type,\n        u.password_hash,\n        u.status\n      FROM users u\n      WHERE u.account_number = $1 AND (u.status IS NULL OR u.status = 'active')\n    `;\n    const result = await query(userQuery, [accountNumber]);\n    if (result.rows.length === 0) {\n      return json({ error: \"Invalid account number or password\" }, { status: 401 });\n    }\n    const user = result.rows[0];\n    const isPasswordValid = await bcrypt.compare(password, user.password_hash);\n    if (!isPasswordValid) {\n      return json({ error: \"Invalid account number or password\" }, { status: 401 });\n    }\n    const userData = {\n      id: user.id,\n      name: user.full_name,\n      firstName: user.first_name,\n      gender: user.gender,\n      accountNumber: user.account_number,\n      accountType: user.account_type\n    };\n    try {\n      const ip_address = getClientAddress();\n      const user_agent = request.headers.get(\"user-agent\");\n      await query(\n        \"SELECT log_activity($1, $2, $3, $4, $5, $6)\",\n        [\n          \"user_login\",\n          user.id,\n          user.account_number,\n          JSON.stringify({\n            full_name: user.full_name,\n            account_type: user.account_type\n          }),\n          ip_address,\n          // Now capturing actual IP address\n          user_agent\n          // Now capturing actual user agent\n        ]\n      );\n    } catch (logError) {\n      console.error(\"Error logging login activity:\", logError);\n    }\n    return json({\n      success: true,\n      user: userData,\n      message: \"Login successful\"\n    });\n  } catch (error) {\n    console.error(\"Authentication error:\", error);\n    if (error.code === \"ECONNREFUSED\" || error.code === \"ENOTFOUND\") {\n      return json({ error: \"Database connection failed\" }, { status: 503 });\n    }\n    return json({ error: \"Authentication failed. Please try again.\" }, { status: 500 });\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}