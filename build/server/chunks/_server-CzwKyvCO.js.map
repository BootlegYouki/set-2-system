{"version":3,"file":"_server-CzwKyvCO.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/admin-settings/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { a as connectToDatabase } from \"../../../../chunks/db.js\";\nimport { g as getUserFromRequest, l as logActivityWithUser } from \"../../../../chunks/auth-helper.js\";\nasync function GET({ request }) {\n  try {\n    const user = getUserFromRequest(request);\n    if (!user || user.account_type !== \"admin\") {\n      return json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    const db = await connectToDatabase();\n    const adminSettingsCollection = db.collection(\"admin_settings\");\n    const result = await adminSettingsCollection.find({}).sort({ setting_key: 1 }).toArray();\n    const settings = {};\n    result.forEach((row) => {\n      let value = row.setting_value;\n      if (row.setting_type === \"number\" && value !== null) {\n        value = parseFloat(value);\n      } else if (row.setting_type === \"boolean\" && value !== null) {\n        value = value === \"true\";\n      } else if (row.setting_type === \"date\" && value !== null) {\n        value = value;\n      } else if (row.setting_type === \"json\" && value !== null) {\n        try {\n          value = JSON.parse(value);\n        } catch (e) {\n          console.error(\"Failed to parse JSON setting:\", row.setting_key, e);\n        }\n      }\n      settings[row.setting_key] = value;\n    });\n    return json({\n      success: true,\n      data: settings\n    });\n  } catch (error) {\n    console.error(\"Error fetching admin settings:\", error);\n    return json(\n      { error: \"Failed to fetch admin settings\" },\n      { status: 500 }\n    );\n  }\n}\nasync function PUT(event) {\n  const user = getUserFromRequest(event.request);\n  if (!user) {\n    return new Response(JSON.stringify({ error: \"Unauthorized\" }), {\n      status: 401,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  }\n  if (user.account_type !== \"admin\") {\n    return new Response(JSON.stringify({ error: \"Forbidden\" }), {\n      status: 403,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  }\n  try {\n    const { settings } = await event.request.json();\n    if (!settings || typeof settings !== \"object\") {\n      return new Response(JSON.stringify({ error: \"Invalid settings data\" }), {\n        status: 400,\n        headers: { \"Content-Type\": \"application/json\" }\n      });\n    }\n    const db = await connectToDatabase();\n    const adminSettingsCollection = db.collection(\"admin_settings\");\n    for (const [key, value] of Object.entries(settings)) {\n      let stringValue = value;\n      if (typeof value === \"object\" && value !== null) {\n        stringValue = JSON.stringify(value);\n      } else if (value !== null) {\n        stringValue = String(value);\n      }\n      if (key.includes(\"date\") && value !== null && value !== \"\") {\n        const dateRegex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])-\\d{4}$/;\n        if (!dateRegex.test(value)) {\n          throw new Error(`Invalid date format for ${key}. Expected MM-DD-YYYY format.`);\n        }\n        const [month, day, year] = value.split(\"-\");\n        const date = new Date(year, month - 1, day);\n        if (isNaN(date.getTime()) || date.getFullYear() != year || date.getMonth() != month - 1 || date.getDate() != day) {\n          throw new Error(`Invalid date value for ${key}: ${value}`);\n        }\n      }\n      await adminSettingsCollection.updateOne(\n        { setting_key: key },\n        {\n          $set: {\n            setting_value: stringValue,\n            updated_at: /* @__PURE__ */ new Date()\n          }\n        },\n        { upsert: true }\n      );\n    }\n    await logActivityWithUser(\n      \"admin_settings_updated\",\n      JSON.stringify({ updated_settings: Object.keys(settings) }),\n      user,\n      event.getClientAddress()\n    );\n    return new Response(JSON.stringify({\n      success: true,\n      message: \"Settings updated successfully\"\n    }), {\n      status: 200,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  } catch (error) {\n    console.error(\"Error updating admin settings:\", error);\n    return new Response(JSON.stringify({\n      error: error.message || \"Internal server error\"\n    }), {\n      status: 500,\n      headers: { \"Content-Type\": \"application/json\" }\n    });\n  }\n}\nexport {\n  GET,\n  PUT\n};\n"],"names":[],"mappings":"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"}