{"version":3,"file":"_server-B1aj0GCD.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/class-rankings/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { a as connectToDatabase } from \"../../../../chunks/db.js\";\nimport { ObjectId } from \"mongodb\";\nimport { v as verifyAuth } from \"../../../../chunks/auth-helper.js\";\nasync function getCurrentSchoolYear(db) {\n  try {\n    const schoolYearSetting = await db.collection(\"admin_settings\").findOne({\n      setting_key: \"current_school_year\"\n    });\n    return schoolYearSetting?.setting_value || \"2025-2026\";\n  } catch (error) {\n    console.error(\"Error fetching current school year:\", error);\n    return \"2025-2026\";\n  }\n}\nasync function GET({ url, request }) {\n  try {\n    const authResult = await verifyAuth(request, [\"student\", \"teacher\", \"adviser\", \"admin\"]);\n    if (!authResult.success) {\n      return json({ error: authResult.error }, { status: 401 });\n    }\n    const currentUser = authResult.user;\n    const db = await connectToDatabase();\n    const studentId = url.searchParams.get(\"studentId\");\n    const quarter = parseInt(url.searchParams.get(\"quarter\")) || 1;\n    const schoolYear = url.searchParams.get(\"schoolYear\") || await getCurrentSchoolYear(db);\n    if (!studentId) {\n      return json({\n        success: false,\n        error: \"Student ID is required\"\n      }, { status: 400 });\n    }\n    if (!ObjectId.isValid(studentId)) {\n      return json({\n        success: false,\n        error: \"Invalid student ID format\"\n      }, { status: 400 });\n    }\n    if (currentUser.account_type === \"student\") {\n      const requestingStudentSection = await db.collection(\"section_students\").findOne({\n        student_id: new ObjectId(currentUser.id),\n        status: \"active\"\n      });\n      const queriedStudentSection = await db.collection(\"section_students\").findOne({\n        student_id: new ObjectId(studentId),\n        status: \"active\"\n      });\n      if (currentUser.id !== studentId && (!requestingStudentSection || !queriedStudentSection || requestingStudentSection.section_id.toString() !== queriedStudentSection.section_id.toString())) {\n        return json({\n          success: false,\n          error: \"Unauthorized: You can only view rankings for your own class\"\n        }, { status: 403 });\n      }\n    }\n    const studentEnrollment = await db.collection(\"section_students\").findOne({\n      student_id: new ObjectId(studentId),\n      status: \"active\"\n    });\n    if (!studentEnrollment) {\n      return json({\n        success: false,\n        error: \"Student not enrolled in any section\"\n      }, { status: 404 });\n    }\n    const section = await db.collection(\"sections\").findOne({\n      _id: studentEnrollment.section_id,\n      status: \"active\"\n    });\n    if (!section) {\n      return json({\n        success: false,\n        error: \"Section not found\"\n      }, { status: 404 });\n    }\n    if (currentUser.account_type === \"teacher\") {\n      const teacherSchedule = await db.collection(\"schedules\").findOne({\n        teacher_id: new ObjectId(currentUser.id),\n        section_id: section._id,\n        schedule_type: \"subject\"\n      });\n      if (!teacherSchedule) {\n        return json({\n          success: false,\n          error: \"Unauthorized: You can only view rankings for sections you teach\"\n        }, { status: 403 });\n      }\n    }\n    if (currentUser.account_type === \"adviser\") {\n      if (!section.adviser_id || section.adviser_id.toString() !== currentUser.id) {\n        return json({\n          success: false,\n          error: \"Unauthorized: You can only view rankings for your advisory section\"\n        }, { status: 403 });\n      }\n    }\n    const sectionInfo = {\n      section_id: section._id.toString(),\n      name: section.name,\n      gradeLevel: section.grade_level\n    };\n    const allStudentsInSection = await db.collection(\"section_students\").find({\n      section_id: section._id,\n      status: \"active\"\n    }).toArray();\n    const gradesCollection = db.collection(\"grades\");\n    const usersCollection = db.collection(\"users\");\n    const studentAverages = [];\n    for (const student of allStudentsInSection) {\n      const studentGrades = await gradesCollection.find({\n        student_id: student.student_id,\n        section_id: section._id,\n        school_year: schoolYear,\n        quarter,\n        \"averages.final_grade\": { $exists: true, $ne: null },\n        verified: true\n      }).toArray();\n      if (studentGrades.length > 0) {\n        const totalGrades = studentGrades.reduce((sum, grade) => {\n          return sum + (grade.averages?.final_grade || 0);\n        }, 0);\n        const average = totalGrades / studentGrades.length;\n        const studentInfo = await usersCollection.findOne({\n          _id: student.student_id\n        });\n        if (studentInfo) {\n          studentAverages.push({\n            studentId: student.student_id.toString(),\n            studentNumber: studentInfo.account_number || \"N/A\",\n            name: `${studentInfo.first_name} ${studentInfo.last_name}`,\n            average,\n            totalSubjects: studentGrades.length\n          });\n        }\n      }\n    }\n    studentAverages.sort((a, b) => b.average - a.average);\n    let currentRank = 1;\n    for (let i = 0; i < studentAverages.length; i++) {\n      if (i > 0 && studentAverages[i].average < studentAverages[i - 1].average) {\n        currentRank = i + 1;\n      }\n      studentAverages[i].rank = currentRank;\n    }\n    const myRanking = studentAverages.find((s) => s.studentId === studentId);\n    const myRank = myRanking?.rank || 0;\n    const myAverage = myRanking?.average || 0;\n    const totalStudents = studentAverages.length;\n    return json({\n      success: true,\n      myRank,\n      myAverage,\n      totalStudents,\n      sectionInfo,\n      rankings: studentAverages\n    });\n  } catch (error) {\n    console.error(\"Error fetching class rankings:\", error);\n    return json({\n      success: false,\n      error: \"Failed to fetch class rankings\"\n    }, { status: 500 });\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}