{"version":3,"file":"auth-helper-DY2o5dhz.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth-helper.js"],"sourcesContent":["import { c as client } from \"./db.js\";\nimport { ObjectId } from \"mongodb\";\nfunction getUserFromRequest(request) {\n  const userHeader = request.headers.get(\"x-user-info\");\n  if (!userHeader) {\n    return null;\n  }\n  try {\n    return JSON.parse(userHeader);\n  } catch (error) {\n    console.error(\"Error parsing user header:\", error);\n    return null;\n  }\n}\nasync function logActivityWithUser(activityType, description, user, activityData = {}, ipAddress = null) {\n  try {\n    const db = client.db(process.env.MONGODB_DB_NAME);\n    const activityLogsCollection = db.collection(\"activity_logs\");\n    let userId = null;\n    if (user?.id) {\n      try {\n        userId = new ObjectId(user.id);\n      } catch (e) {\n        userId = user.id;\n      }\n    }\n    const logEntry = {\n      activity_type: activityType,\n      user_id: userId,\n      user_account_number: user?.account_number || null,\n      activity_data: {\n        description,\n        full_name: user?.name || user?.full_name || \"Unknown\",\n        account_type: user?.account_type || \"Unknown\",\n        ...activityData\n      },\n      ip_address: ipAddress,\n      created_at: /* @__PURE__ */ new Date()\n    };\n    await activityLogsCollection.insertOne(logEntry);\n  } catch (error) {\n    console.error(\"Error logging activity:\", error);\n  }\n}\nasync function verifyAuth(request, allowedRoles = []) {\n  try {\n    const user = getUserFromRequest(request);\n    if (!user || !user.id) {\n      return { success: false, error: \"Authentication required\" };\n    }\n    const db = client.db(process.env.MONGODB_DB_NAME);\n    const usersCollection = db.collection(\"users\");\n    const userRecord = await usersCollection.findOne(\n      { _id: new ObjectId(user.id) },\n      { projection: { account_type: 1, status: 1 } }\n    );\n    if (!userRecord) {\n      return { success: false, error: \"User not found\" };\n    }\n    if (userRecord.status === \"archived\") {\n      return { success: false, error: \"Account is archived\" };\n    }\n    if (allowedRoles.length > 0 && !allowedRoles.includes(userRecord.account_type)) {\n      return {\n        success: false,\n        error: `Access denied. Required roles: ${allowedRoles.join(\", \")}`\n      };\n    }\n    const updatedUser = {\n      ...user,\n      account_type: userRecord.account_type\n    };\n    return { success: true, user: updatedUser };\n  } catch (error) {\n    console.error(\"Error verifying authentication:\", error);\n    return { success: false, error: \"Authentication verification failed\" };\n  }\n}\nexport {\n  getUserFromRequest as g,\n  logActivityWithUser as l,\n  verifyAuth as v\n};\n"],"names":[],"mappings":"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"}