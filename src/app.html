<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
		
		<!-- Preload critical resources -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
		<link rel="preload" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
		
		<!-- Load Material Symbols immediately for loading screen -->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" />
		
		<!-- Fallback for browsers that don't support preload -->
		<noscript>
			<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
			<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" />
		</noscript>
		
		<!-- Critical CSS inlined for instant render -->
		<style>
			/* Critical CSS - Base styles for immediate render */
			* {
				-webkit-tap-highlight-color: transparent;
				-webkit-touch-callout: none;
				touch-action: manipulation;
				box-sizing: border-box;
			}
			
			:root {
				/* Essential variables for initial render */
				--school-primary: #1565c0;
				--md-sys-color-surface: #ffffff;
				--md-sys-color-on-surface: #1c1b1f;
				--md-sys-color-primary: var(--school-primary);
				--md-sys-color-primary-container: #e3f2fd;
				--transition-normal: 0.3s ease;
			}
			
			[data-theme="dark"] {
				--md-sys-color-surface: #121212;
				--md-sys-color-on-surface: #e0e0e0;
				--md-sys-color-primary-container: #1e3a8a;
			}
			
			html {
				background-color: var(--md-sys-color-surface);
				transition: background-color var(--transition-normal) !important;
			}
			
			body {
				margin: 0;
				padding: 0;
				font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				font-size: 14px;
				font-weight: 400;
				line-height: 1.5;
				color: var(--md-sys-color-on-surface);
				background-color: var(--md-sys-color-surface);
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
				transition: color var(--transition-normal), background-color var(--transition-normal);
			}
			
			/* Loading state styles */
			.app-loading {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
				background-color: var(--md-sys-color-surface);
				transition: opacity 0.3s ease;
				z-index: 9999;
			}
			
			.app-loading-content {
				text-align: center;
			}
			.app-loading-content .material-symbols-outlined {
				font-size: 120px;
			}
			
			.app-loading-progress {
				width: 280px;
				display: flex;
				align-items: center;
				gap: 12px;
				margin-top: 8px;
			}
			
			.app-loading-bar {
				flex: 1;
				height: 6px;
				background-color: var(--md-sys-color-outline-variant);
				border-radius: 3px;
				overflow: hidden;
				position: relative;
			}
			
			.app-loading-fill {
				height: 100%;
				background: linear-gradient(90deg, 
					var(--md-sys-color-primary-container) 0%, 
					var(--md-sys-color-secondary-container) 100%);
				border-radius: 3px;
				transition: width 0.1s linear;
				position: relative;
				overflow: hidden;
				width: 0%;
			}
			
			.app-loading-fill::after {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: linear-gradient(90deg, 
					transparent 0%, 
					rgba(255, 255, 255, 0.4) 30%,
					rgba(255, 255, 255, 0.6) 50%,
					rgba(255, 255, 255, 0.4) 70%,
					transparent 100%);
				animation: shimmer 1.2s ease-in-out infinite;
				width: 100px;
			}
			
			@keyframes shimmer {
				0% { 
					transform: translateX(-120px);
					opacity: 0;
				}
				20% {
					opacity: 1;
				}
				80% {
					opacity: 1;
				}
				100% { 
					transform: translateX(300px);
					opacity: 0;
				}
			}
			
			/* Hide loading when app is ready */
			.app-ready .app-loading {
				opacity: 0;
				pointer-events: none;
			}
		</style>
		
		<script>
			// Set theme immediately to prevent flash
			(function() {
				try {
					const savedTheme = localStorage.getItem('theme');
					// Default to light mode if no saved preference
					const theme = savedTheme === 'dark' ? 'dark' : 'light';
					document.documentElement.setAttribute('data-theme', theme);
				} catch (e) {
					// Fallback to light mode if localStorage is not available
					document.documentElement.setAttribute('data-theme', 'light');
				}
			})();
			
			// Resource loading manager
			window.resourceLoadingManager = {
				totalResources: 0,
				loadedResources: 0,
				criticalResources: [],
				isComplete: false,
				callbacks: [],
				
				addResource: function(resource) {
					this.criticalResources.push(resource);
					this.totalResources++;
					this.updateProgress();
				},
				
				markResourceLoaded: function() {
					this.loadedResources++;
					this.updateProgress();
					this.checkCompletion();
				},
				
				updateProgress: function() {
					const progress = this.totalResources > 0 ? (this.loadedResources / this.totalResources) * 100 : 0;
					if (window.appLoadingManager) {
						window.appLoadingManager.updateProgress(Math.min(progress, 95)); // Cap at 95% until fully complete
					}
				},
				
				checkCompletion: function() {
					if (this.loadedResources >= this.totalResources && !this.isComplete) {
						this.isComplete = true;
						// Don't automatically hide loading - let layout.svelte control this
						if (window.appLoadingManager) {
							window.appLoadingManager.updateProgress(100);
						}
						// Notify callbacks that resources are complete
						this.callbacks.forEach(callback => callback());
						this.callbacks = [];
					}
				},
				
				onComplete: function(callback) {
					if (this.isComplete) {
						callback();
					} else {
						this.callbacks.push(callback);
					}
				}
			};
			
			// App loading management
			window.appLoadingManager = {
				isReady: false,
				readyCallbacks: [],
				loadingProgress: 0,
				isAuthenticated: false,
				
				onReady: function(callback) {
					if (this.isReady) {
						callback();
					} else {
						this.readyCallbacks.push(callback);
					}
				},
				
				setReady: function() {
					this.isReady = true;
					document.documentElement.classList.add('app-ready');
					this.readyCallbacks.forEach(callback => callback());
					this.readyCallbacks = [];
				},
				
				updateProgress: function(progress) {
					this.loadingProgress = progress;
					const fillElement = document.getElementById('app-loading-fill');
					if (fillElement) {
						fillElement.style.width = progress + '%';
					}
				},
				
				checkAuthState: function() {
					try {
						const authState = localStorage.getItem('authState');
						if (authState) {
							const parsed = JSON.parse(authState);
							this.isAuthenticated = parsed.isAuthenticated === true;
						}
					} catch (e) {
						this.isAuthenticated = false;
					}
					return this.isAuthenticated;
				}
			};
			
			// Track critical resources
			function trackCriticalResources() {
				// Track Google Fonts
				const fontLinks = document.querySelectorAll('link[href*="fonts.googleapis.com"]');
				fontLinks.forEach(link => {
					window.resourceLoadingManager.addResource('font');
					link.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
					link.addEventListener('error', () => window.resourceLoadingManager.markResourceLoaded()); // Count errors as loaded to prevent hanging
				});
				
				// Track preloaded stylesheets
				const preloadLinks = document.querySelectorAll('link[rel="preload"][as="style"]');
				preloadLinks.forEach(link => {
					window.resourceLoadingManager.addResource('preload-style');
					link.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
					link.addEventListener('error', () => window.resourceLoadingManager.markResourceLoaded());
				});
				
				// Track when DOM is ready
				window.resourceLoadingManager.addResource('dom');
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', () => window.resourceLoadingManager.markResourceLoaded());
				} else {
					window.resourceLoadingManager.markResourceLoaded();
				}
				
				// Track Vite/SvelteKit assets (CSS and JS bundles)
				const observer = new MutationObserver((mutations) => {
					mutations.forEach((mutation) => {
						mutation.addedNodes.forEach((node) => {
							if (node.nodeType === 1) { // Element node
								// Track CSS files (including Vite generated ones)
								if (node.tagName === 'LINK' && node.rel === 'stylesheet' && !node.href.includes('fonts.googleapis.com')) {
									window.resourceLoadingManager.addResource('css');
									node.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
									node.addEventListener('error', () => window.resourceLoadingManager.markResourceLoaded());
								}
								// Track JavaScript modules (including Vite bundles)
								else if (node.tagName === 'SCRIPT' && (node.src || node.type === 'module')) {
									window.resourceLoadingManager.addResource('js');
									node.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
									node.addEventListener('error', () => window.resourceLoadingManager.markResourceLoaded());
								}
							}
						});
					});
				});
				
				// Start observing for dynamically added assets
				observer.observe(document.head, { childList: true, subtree: true });
				
				// Observe body when it's available
				if (document.body) {
					observer.observe(document.body, { childList: true, subtree: true });
				} else {
					document.addEventListener('DOMContentLoaded', () => {
						if (document.body) {
							observer.observe(document.body, { childList: true, subtree: true });
						}
					});
				}
				
				// Track existing CSS and JS files
				const existingCSS = document.querySelectorAll('link[rel="stylesheet"]:not([href*="fonts.googleapis.com"])');
				existingCSS.forEach(link => {
					window.resourceLoadingManager.addResource('css');
					if (link.sheet) {
						window.resourceLoadingManager.markResourceLoaded();
					} else {
						link.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
						link.addEventListener('error', () => window.resourceLoadingManager.markResourceLoaded());
					}
				});
				
				const existingJS = document.querySelectorAll('script[src], script[type="module"]');
				existingJS.forEach(script => {
					window.resourceLoadingManager.addResource('js');
					// If script is already loaded or inline, mark as loaded
					if (!script.src || script.readyState === 'complete') {
						window.resourceLoadingManager.markResourceLoaded();
					} else {
						script.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
						script.addEventListener('error', () => window.resourceLoadingManager.markResourceLoaded());
					}
				});
				
				// Track when all resources are loaded (including dynamic ones)
				window.resourceLoadingManager.addResource('window-load');
				if (document.readyState === 'complete') {
					window.resourceLoadingManager.markResourceLoaded();
				} else {
					window.addEventListener('load', () => window.resourceLoadingManager.markResourceLoaded());
				}
				
				// Additional check for SvelteKit app initialization
				window.resourceLoadingManager.addResource('svelte-app');
				
				// Check if SvelteKit has initialized by looking for app container content
				function checkSvelteAppReady() {
					const appContainer = document.querySelector('[data-sveltekit-preload-data]');
					if (appContainer && appContainer.children.length > 0) {
						// Check if there's actual content (not just loading state)
						const hasContent = appContainer.querySelector('main, .app-content, [class*="page"], [class*="layout"]');
						if (hasContent) {
							window.resourceLoadingManager.markResourceLoaded();
							return true;
						}
					}
					return false;
				}
				
				// Check immediately and then periodically
				if (!checkSvelteAppReady()) {
					const checkInterval = setInterval(() => {
						if (checkSvelteAppReady()) {
							clearInterval(checkInterval);
						}
					}, 50);
					
					// Fallback timeout for SvelteKit app check
					setTimeout(() => {
						clearInterval(checkInterval);
						window.resourceLoadingManager.markResourceLoaded();
					}, 3000);
				}
			}
			
			// Initialize resource tracking
			trackCriticalResources();
			
			// Check authentication state for fallback timing
			window.appLoadingManager.checkAuthState();
			
			// Fallback timeout based on authentication state (in case resources load too quickly or hang)
			const isAuthenticated = window.appLoadingManager.isAuthenticated;
			const fallbackTimeout = isAuthenticated ? 3000 : 6000;
			
			setTimeout(() => {
				if (!window.appLoadingManager.isReady) {
					console.log('Loading timeout reached, forcing completion');
					window.appLoadingManager.updateProgress(100);
					window.appLoadingManager.setReady();
				}
			}, fallbackTimeout);
			
			// Minimum loading time to prevent flash
			const minimumLoadTime = isAuthenticated ? 1500 : 2500;
			setTimeout(() => {
				// Only allow completion after minimum time has passed
				if (window.resourceLoadingManager.isComplete && !window.appLoadingManager.isReady) {
					window.appLoadingManager.setReady();
				}
			}, minimumLoadTime);
		</script>
		
		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<!-- App loading state -->
		<div class="app-loading" id="app-loading">
			<div class="app-loading-content">
				<span class="material-symbols-outlined app-loading-icon">school</span>
				
				<!-- Progress bar -->
				<div class="app-loading-progress">
					<div class="app-loading-bar">
						<div class="app-loading-fill" id="app-loading-fill"></div>
					</div>
				</div>
			</div>
		</div>
		
		<div style="display: contents">%sveltekit.body%</div>
	</body>
</html>
